<div class="card p-4">
  <p-toast />
  <p-confirmDialog />
  
  <h2 class="text-2xl font-bold mb-4">Gestión de Pedidos</h2>

  <div class="grid grid-cols-12 gap-4 mb-4">
    <div class="col-span-12 md:col-span-4">
      <label class="block mb-2 font-medium">Filtrar por Estado</label>
      <p-select
        [(ngModel)]="selectedEstado"
        [options]="estados"
        optionLabel="label"
        optionValue="value"
        placeholder="Todos los estados"
        class="w-full"
      />
    </div>

    <div class="col-span-12 md:col-span-8 flex items-end gap-2">
      <p-button
        label="Filtrar"
        icon="pi pi-search"
        (onClick)="filterByEstado()"
        severity="primary"
      />
      <p-button
        label="Limpiar"
        icon="pi pi-filter-slash"
        (onClick)="clearFilters()"
        severity="secondary"
        [outlined]="true"
      />
    </div>
  </div>

  <p-table
    [value]="pedidosFiltrados"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} pedidos"
    dataKey="id"
    styleClass="p-datatable-striped"
  >
    <ng-template #header>
      <tr>
        <th style="width: 3rem"></th>
        <th pSortableColumn="id">
          ID <p-sortIcon field="id" />
        </th>
        <th>Usuario</th>
        <th pSortableColumn="fechaCreacion">
          Fecha <p-sortIcon field="fechaCreacion" />
        </th>
        <th pSortableColumn="total">
          Total <p-sortIcon field="total" />
        </th>
        <th>Items</th>
        <th pSortableColumn="estado">
          Estado <p-sortIcon field="estado" />
        </th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template #body let-pedido>
      <tr>
        <td>
          <p-button
            type="button"
            [icon]="expandedPedidoId === pedido.id ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
            [text]="true"
            (onClick)="expandedPedidoId = expandedPedidoId === pedido.id ? undefined : pedido.id"
          />
        </td>
        <td>
          <span class="font-mono font-bold">#{{ pedido.id }}</span>
        </td>
        <td>{{ getUsuarioNombre(pedido) }}</td>
        <td>{{ formatDate(pedido.fechaCreacion || '') }}</td>
        <td>
          <span class="font-bold text-blue-600">
            {{ pedido.total | currency: 'USD' }}
          </span>
          @if (pedido.descuento && pedido.descuento > 0) {
            <span class="text-xs text-green-600 block">
              Desc: -{{ pedido.descuento | currency: 'USD' }}
            </span>
          }
        </td>
        <td>
          <span class="text-gray-600">{{ pedido.detalles?.length || 0 }} item(s)</span>
        </td>
        <td>
          <p-tag
            [value]="getEstadoLabel(pedido.estado)"
            [severity]="getSeverity(pedido.estado)"
          />
        </td>
        <td>
          <div class="flex gap-2">
            <p-button
              label="Ver"
              icon="pi pi-eye"
              [rounded]="true"
              [text]="true"
              severity="info"
              (onClick)="verDetalle(pedido)"
              pTooltip="Ver detalle"
            />
            <p-button
              icon="pi pi-times"
              [rounded]="true"
              [text]="true"
              severity="danger"
              (onClick)="cancelarPedido(pedido)"
              [disabled]="pedido.estado === 'CANCELADO' || pedido.estado === 'COMPLETADO'"
              pTooltip="Cancelar pedido"
            />
          </div>
        </td>
      </tr>
      @if (expandedPedidoId === pedido.id) {
        <tr>
          <td colspan="8">
            <div class="p-4 bg-gray-50 rounded">
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <h3 class="font-bold text-lg mb-3">Items del Pedido</h3>
                  <div class="border rounded-lg overflow-hidden bg-white">
                    <table class="w-full text-sm">
                      <thead class="bg-gray-100">
                        <tr>
                          <th class="px-3 py-2 text-left">Producto</th>
                          <th class="px-3 py-2 text-center">Cantidad</th>
                          <th class="px-3 py-2 text-right">Precio Unit.</th>
                          <th class="px-3 py-2 text-right">Subtotal</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (detalle of pedido.detalles; track detalle.id) {
                          <tr class="border-t">
                            <td class="px-3 py-2">
                              {{ detalle.producto?.nombre || 'Producto #' + detalle.producto?.id }}
                            </td>
                            <td class="px-3 py-2 text-center">{{ detalle.cantidad }}</td>
                            <td class="px-3 py-2 text-right">{{ detalle.precioUnitario | currency: 'USD' }}</td>
                            <td class="px-3 py-2 text-right font-medium">
                              {{ detalle.subtotal | currency: 'USD' }}
                            </td>
                          </tr>
                        }
                      </tbody>
                      <tfoot class="bg-gray-50">
                        @if (pedido.descuento && pedido.descuento > 0) {
                          <tr class="border-t">
                            <td colspan="3" class="px-3 py-2 text-right">Subtotal:</td>
                            <td class="px-3 py-2 text-right">
                              {{ (pedido.total + pedido.descuento) | currency: 'USD' }}
                            </td>
                          </tr>
                          <tr>
                            <td colspan="3" class="px-3 py-2 text-right text-green-600">Descuento:</td>
                            <td class="px-3 py-2 text-right text-green-600">
                              -{{ pedido.descuento | currency: 'USD' }}
                            </td>
                          </tr>
                        }
                        <tr class="font-bold">
                          <td colspan="3" class="px-3 py-2 text-right">Total:</td>
                          <td class="px-3 py-2 text-right text-blue-600">
                            {{ pedido.total | currency: 'USD' }}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                <div>
                  <h3 class="font-bold text-lg mb-3">Historial de Estados</h3>
                  <p-timeline
                    [value]="getHistorialMock(pedido)"
                    align="left"
                    styleClass="customized-timeline"
                  >
                    <ng-template #content let-event>
                      <div class="flex flex-col">
                        <p-tag
                          [value]="getEstadoLabel(event.estado)"
                          [severity]="getSeverity(event.estado)"
                          styleClass="mb-2"
                        />
                        <small class="text-gray-600">{{ formatDate(event.fecha) }}</small>
                      </div>
                    </ng-template>

                    <ng-template #marker let-event>
                      <span 
                        class="flex items-center justify-center w-8 h-8 rounded-full z-10"
                        [ngClass]="{
                          'bg-yellow-500': event.estado === 'PENDIENTE',
                          'bg-blue-500': event.estado === 'EN_PROCESO',
                          'bg-green-500': event.estado === 'COMPLETADO',
                          'bg-red-500': event.estado === 'CANCELADO'
                        }"
                      >
                        <i class="pi pi-check text-white"></i>
                      </span>
                    </ng-template>
                  </p-timeline>

                  <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                    <p class="mb-1"><strong>Usuario:</strong> {{ getUsuarioNombre(pedido) }}</p>
                    <p class="mb-1"><strong>Creado:</strong> {{ formatDate(pedido.fechaCreacion || '') }}</p>
                    <p><strong>Última actualización:</strong> {{ formatDate(pedido.fechaActualizacion || '') }}</p>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      }
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="8" class="text-center py-8">
          <i class="pi pi-inbox text-4xl text-gray-400 mb-2"></i>
          <p class="text-gray-500">No se encontraron pedidos</p>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>