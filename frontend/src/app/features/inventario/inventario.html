<div class="p-4">
  <!-- Toolbar -->
  <p-toolbar class="mb-6">
    <ng-template #start>
      <p-button 
        label="Nuevo Producto" 
        icon="pi pi-plus" 
        class="mr-2" 
        (onClick)="openNew()" 
      />
      <p-button 
        severity="danger" 
        label="Eliminar" 
        icon="pi pi-trash" 
        outlined 
        (onClick)="deleteSelectedProducts()" 
        [disabled]="!selectedProductos || !selectedProductos.length" 
      />
    </ng-template>

    <ng-template #end>
      <p-button 
        label="Exportar" 
        icon="pi pi-upload" 
        severity="secondary" 
        (onClick)="exportCSV($event)" 
      />
    </ng-template>
  </p-toolbar>

  <!-- Tabla -->
  <p-table
    #dt
    [value]="productos"
    [rows]="10"
    [paginator]="true"
    [globalFilterFields]="['nombre', 'categoria', 'estado']"
    [tableStyle]="{ 'min-width': '75rem' }"
    [(selection)]="selectedProductos"
    [rowHover]="true"
    dataKey="id"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
    [showCurrentPageReport]="true"
    [loading]="loading"
  >
    <ng-template #caption>
      <div class="flex items-center justify-between">
        <h5 class="m-0">Gestión de Inventario</h5>
        <p-iconfield>
          <p-inputicon class="pi pi-search" />
          <input 
            pInputText 
            type="text" 
            (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
            placeholder="Buscar productos..." 
          />
        </p-iconfield>
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox />
        </th>
        <th pSortableColumn="id" style="min-width: 8rem">
          <div class="flex items-center gap-2">
            ID
            <p-sortIcon field="id" />
          </div>
        </th>
        <th pSortableColumn="nombre" style="min-width: 16rem">
          <div class="flex items-center gap-2">
            Nombre
            <p-sortIcon field="nombre" />
          </div>
        </th>
        <th pSortableColumn="precio" style="min-width: 10rem">
          <div class="flex items-center gap-2">
            Precio
            <p-sortIcon field="precio" />
          </div>
        </th>
        <th pSortableColumn="stock" style="min-width: 8rem">
          <div class="flex items-center gap-2">
            Stock
            <p-sortIcon field="stock" />
          </div>
        </th>
        <th pSortableColumn="stockminimo" style="min-width: 10rem">
          <div class="flex items-center gap-2">
            Stock Mínimo
            <p-sortIcon field="stockminimo" />
          </div>
        </th>
        <th pSortableColumn="categoria" style="min-width: 12rem">
          <div class="flex items-center gap-2">
            Categoría
            <p-sortIcon field="categoria" />
          </div>
        </th>
        <th pSortableColumn="estado" style="min-width: 10rem">
          <div class="flex items-center gap-2">
            Estado
            <p-sortIcon field="estado" />
          </div>
        </th>
        <th style="min-width: 12rem">Acciones</th>
      </tr>
    </ng-template>

    <ng-template #body let-producto>
      <tr>
        <td style="width: 3rem">
          <p-tableCheckbox [value]="producto" />
        </td>
        <td>{{ producto.id }}</td>
        <td>{{ producto.nombre }}</td>
        <td>{{ producto.precio | currency: 'USD' }}</td>
        <td>
          <span [class]="producto.stock <= (producto.stockminimo || 0) ? 'text-red-600 font-bold' : ''">
            {{ producto.stock }}
          </span>
        </td>
        <td>{{ producto.stockminimo || 0 }}</td>
        <td>{{ producto.categoria }}</td>
        <td>
          <p-tag 
            [value]="producto.estado || 'DISPONIBLE'" 
            [severity]="getSeverity(producto.estado || 'DISPONIBLE')"
          />
        </td>
        <td>
          <p-button 
            icon="pi pi-pencil" 
            class="mr-2" 
            [rounded]="true" 
            [outlined]="true" 
            (click)="editProduct(producto)" 
          />
          <p-button 
            icon="pi pi-trash" 
            severity="danger" 
            [rounded]="true" 
            [outlined]="true" 
            (click)="deleteProduct(producto)" 
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Diálogo de Producto -->
  <p-dialog 
    [(visible)]="productDialog" 
    [style]="{ width: '550px' }" 
    header="Detalles del Producto" 
    [modal]="true"
  >
    <ng-template #content>
      <div class="flex flex-col gap-6">
        <div>
          <label for="nombre" class="block font-bold mb-3">Nombre *</label>
          <input 
            type="text" 
            pInputText 
            id="nombre" 
            [(ngModel)]="producto.nombre" 
            required 
            autofocus 
            fluid 
          />
          <small class="text-red-500" *ngIf="submitted && !producto.nombre">
            El nombre es requerido.
          </small>
        </div>

        <div>
          <label for="descripcion" class="block font-bold mb-3">Descripción</label>
          <textarea 
            id="descripcion" 
            pTextarea 
            [(ngModel)]="producto.descripcion" 
            rows="3" 
            cols="20" 
            fluid
          ></textarea>
        </div>

        <div>
          <label for="categoria" class="block font-bold mb-3">Categoría *</label>
          <p-select 
            [(ngModel)]="producto.categoria" 
            inputId="categoria" 
            [options]="categorias" 
            optionLabel="label" 
            optionValue="value" 
            placeholder="Seleccione una categoría" 
            fluid 
          />
        </div>

        <div>
          <label for="estado" class="block font-bold mb-3">Estado</label>
          <p-select 
            [(ngModel)]="producto.estado" 
            inputId="estado" 
            [options]="estados" 
            optionLabel="label" 
            optionValue="value" 
            placeholder="Seleccione un estado" 
            fluid 
          />
        </div>

        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-6">
            <label for="precio" class="block font-bold mb-3">Precio *</label>
            <p-inputnumber 
              id="precio" 
              [(ngModel)]="producto.precio" 
              mode="currency" 
              currency="USD" 
              locale="en-US" 
              fluid 
            />
            <small class="text-red-500" *ngIf="submitted && !producto.precio">
              El precio es requerido.
            </small>
          </div>
          <div class="col-span-6">
            <label for="stock" class="block font-bold mb-3">Stock *</label>
            <p-inputnumber 
              id="stock" 
              [(ngModel)]="producto.stock" 
              fluid 
            />
            <small class="text-red-500" *ngIf="submitted && !producto.stock">
              El stock es requerido.
            </small>
          </div>
        </div>

        <div>
          <label for="stockminimo" class="block font-bold mb-3">Stock Mínimo</label>
          <p-inputnumber 
            id="stockminimo" 
            [(ngModel)]="producto.stockminimo" 
            fluid 
          />
        </div>
      </div>
    </ng-template>

    <ng-template #footer>
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        text 
        (click)="hideDialog()" 
      />
      <p-button 
        label="Guardar" 
        icon="pi pi-check" 
        (click)="saveProduct()" 
      />
    </ng-template>
  </p-dialog>

  <!-- Diálogo de Confirmación -->
  <p-confirmDialog [style]="{ width: '450px' }" />
</div>

